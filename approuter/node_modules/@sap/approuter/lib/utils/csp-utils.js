'use strict';

const {loadJsonVar} = require('../configuration/env-config');
const headerUtil = require('./header-util');

const EXTENDED_LOGIN_CSP = process.env.EXTENDED_LOGIN_CSP === 'true';

function generateScriptTagAndCspHeader(logger) {
  let openScriptTag = '<script>';
  let cspHeaderValue = EXTENDED_LOGIN_CSP
    ? 'default-src \'none\'; script-src \'self\' \'unsafe-inline\'; style-src \'self\' \'unsafe-inline\'; img-src \'self\' data:; connect-src \'self\'; font-src \'self\'; base-uri \'none\'; form-action \'none\'; frame-ancestors *'
    : 'script-src \'self\' \'unsafe-inline\'; frame-ancestors *';

  try {
    if (loadJsonVar('INCLUDE_NONCE_ATTR') !== false) {
      const nonce = headerUtil.generateNonce();
      openScriptTag = `<script nonce="${nonce}">`;
      cspHeaderValue = EXTENDED_LOGIN_CSP
        ? `default-src 'none'; script-src 'self' 'nonce-${nonce}'; style-src 'self' 'nonce-${nonce}'; img-src 'self' data:; connect-src 'self'; font-src 'self'; base-uri 'none'; form-action 'none'; frame-ancestors *`
        : `script-src 'self' 'nonce-${nonce}'; frame-ancestors *`;
    }
  } catch (e) {
    logger.error('Failed to generate nonce for CSP header: %s', e.message);
  }

  return {
    openScriptTag,
    cspHeaderValue,
  };
}


module.exports = {
  generateScriptTagAndCspHeader,
};
